blueprint:
  name: Aqara-Magic-Cube-T1-Pro-(CTP-R01) - 2023-12-09
  author: SirGoodenough
  description: >
    This Blueprint uses a Zigbee2MQTT built sensor to sort out the 58+
    unique commands (118+ total) available from the Xiaomi Magic Cube Remote. (Some unique commands
    listed as + are not counted & available thru templating only. See the related document.)

    **NOTE:** This blueprint is for the PRO cube version ONLY and is not fully compatible
    with the original version of the cube. Links for those are in my [GIT repository](https://github.com/SirGoodenough/HA_Blueprints).

    This cube has an 'Action' mode (Shown below with this graphic: ðŸ«³ ACTION MODE ONLY ðŸ«³ )

    and a 'Scene' mode (Shown below with this graphic: ðŸ‘€ SCENE MODE ONLY ðŸ‘€ ).

    Make sure the cube is in the mode you think it is in when triggering it.
    The functions are separate. IE 'Action - slide' will do something different from 'Scene - slide'.

    The split out of functions gives you the ability to assign local scripts or functions
    to do the things you want the remote to do.

    Functions that are left empty will simply do nothing.

    #### ðŸŽ There is a set of 36 + 18 actions that will trigger on specific actions on specific sides that are listed as **Group 1 ðŸŽ**

    #### ðŸŠ There is a set of 6 + 3 actions that will trigger on specific actions on *ANY* side that are listed as **Group 2 ðŸŠ**

    #### ðŸ There is a set of 30 + 30 event functions that will trigger on cube flips to & from specific sides that are listed as **Group 3 ðŸ**

    #### ðŸ© There are 5 actions (shake & throw for each mode & hold in scene mode) that only occur once in each mode & are OK to be combined with any other group in that mode. ðŸ©

    Please be aware that ALL actions except the 4 listed above,
    ðŸ© will trigger an action in **ALL 3 groups in the matching mode at the same time** every time.
    Therefore I suggest if you just have a couple of things you want this remote to do that
    you choose the *ANY / Group 2 / ðŸŠ* events. 
    Action events and Scene events are separate from each other.

    If you want more than a few events, you should select actions in **Group 1 / ðŸŽ
    OR Group 3 / ðŸ**.

    With careful selection you can use mixed groups, but you run the risk of a single
    cube action triggering more than 1 Home Assistant action and making a mess of
    things ðŸ±.


    #### NOTICE: This cube *can* be triggered 124 ways, but only 38(+54) of them are
    unique (with templating).

    ##### This blueprint has been known to freak out when there are spaces or odd characters
    in the MQTT Topic. Make sure there are no spaces, ONLY a single word,
    and ONLY A thru Z, a thru z, and 0 thru 9 in the topic.
    (```  /  ``` is ok between device and topic) If there are,
    you will need to change the name of the cube to remove those characters.

    ### IF YOU SEE --> TemplateError: Must provide a device or entity ID

    If you get an error like that, The friendly_name in Z2M likely does not match the 
    friendly_name on HA. To fix go into the Z2M ```Open web UI``` and set the 
    friendly_name there. Setting this in just HA or in Z2M without ticking the update HA
    box will cause this. See the blueprint documentation page for details.


    There is sample code to make the template sensor in the help file on GitHib named
    [Zigbee2MQTT - Xiaomi Cube Controller MQTT Triggered.md](https://github.com/SirGoodenough/HA_Blueprints/blob/master/Automations/Zigbee2MQTT%20-%20Xiaomi%20Cube%20Controller%20MQTT%20Triggered.md)
    & in the [community page related to this](https://community.home-assistant.io/t/zigbee2mqtt-xiaomi-cube-controller/393203).


    Within this blueprint there is an event handler that will latch the last command
    that the blueprint finds and sends that to the event buss. From there a simple
    Template sensor can grab it and show you the last action sent. Thie will help
    when setting up new functions and to troubleshoot strange behaviours.


    > This was forked from https://community.home-assistant.io/t/z2m-xiaomi-cube-controller/263006
    1.2 project authored by luckypoppy and the friends he pulled together to create
    the base. I sincerely thank Him (Them) for their work. I felt there needed to
    be more documentation for rookie users to properly set this up. I had quite a
    few questions and when I saw a few questions in that chat from people struggling,
    I wanted to help. I also had a better idea for troubleshooting info.

    ðŸ“© There is not an official version control system for Blueprints. However I have
    found something that comes pretty close. It is not perfect, but for **MOST**
    Blueprints, it does just fine. I encourage you to check this script out and use
    it to easily check if I have updated this blueprint. ðŸ”— [koter84 Blueprint Update Script](https://github.com/koter84/HomeAssistant_Blueprints_Update/)


    [Community link for this blueprint](https://community.home-assistant.io/t/zigbee2mqtt-aqara-magic-cube-t1-pro-ctp-r01-xiaomi-lumi-cagl02/525111)

  source_url: https://github.com/SirGoodenough/HA_Blueprints/blob/master/Automations/Zigbee2MQTT-Aqara-Magic-Cube-T1-Pro-CTP-R01-Xiaomi-Lumi.yaml
  domain: automation
  homeassistant:
    min_version: 2023.8.0
  input:
    topic:
      name: Topic
      description: >
        The main MQTT Topic for your cube. 

        Details on finding the correct topic can be found here: 

        [Find my Cube Topic](https://github.com/SirGoodenough/HA_Blueprints/blob/master/Automations/Zigbee2MQTT-Aqara-Magic-Cube-T1-Pro-CTP-R01-Xiaomi-Lumi.md#to-make-the-blueprint-work-it-will-need)

      default: "zigbee2mqtt/?"
      selector:
        text:
          multiline: false
    additional_conditions:
      name: Additional conditions
      description: |
        Extra conditions you may want to add to this automation 
        (Example: Home occupied, TV on, etc)
      default: []
      selector:
        condition:
    action_slide_face_1:
      name: ðŸ«³ ACTION MODE ONLY ðŸ«³ Group 1 ðŸŽ Slide with face 1 up
      description: Face 1 is the one with the 'Aqara' LOGO
      default: []
      selector:
        action: {}
    action_doubletap_face_1:
      name: ðŸ«³ ACTION MODE ONLY ðŸ«³ Group 1 ðŸŽ Double tap with face 1 up
      description: Face 1 is the one with the 'Aqara' LOGO
      default: []
      selector:
        action: {}
    action_flipped90_face_1:
      name: ðŸ«³ ACTION MODE ONLY ðŸ«³ Group 1 ðŸŽ Flip 90 degrees to face 1
      description: Face 1 is the one with the 'Aqara' LOGO
      default: []
      selector:
        action: {}
    action_flipped180_face_1:
      name: ðŸ«³ ACTION MODE ONLY ðŸ«³ Group 1 ðŸŽ Flip 180 degrees to face 1
      description:
        "**NOTE:** This action is trick to master, and should be used sparingly...

        Face 1 is the one with the 'Aqara' LOGO"
      default: []
      selector:
        action: {}
    action_flip_from_any_to_face_1:
      name: ðŸ«³ ACTION MODE ONLY ðŸ«³ Group 1 ðŸŽ Flip From any face to face 1
      description: Face 1 is the one with the 'Aqara' LOGO
      default: []
      selector:
        action: {}
    action_rotate_cw_face_1:
      name: ðŸ«³ ACTION MODE ONLY ðŸ«³ Group 1 ðŸŽ Rotate CW with face 1 up
      description: Face 1 is the one with the 'Aqara' LOGO
      default: []
      selector:
        action: {}
    action_rotate_ccw_face_1:
      name: ðŸ«³ ACTION MODE ONLY ðŸ«³ Group 1 ðŸŽ Rotate CCW with face 1 up
      description: Face 1 is the one with the 'Aqara' LOGO
      default: []
      selector:
        action: {}
    action_slide_face_2:
      name: ðŸ«³ ACTION MODE ONLY ðŸ«³ Group 1 ðŸŽ Slide with face 2 up
      default: []
      selector:
        action: {}
    action_doubletap_face_2:
      name: ðŸ«³ ACTION MODE ONLY ðŸ«³ Group 1 ðŸŽ Double tap with face 2 up
      default: []
      selector:
        action: {}
    action_flipped90_face_2:
      name: ðŸ«³ ACTION MODE ONLY ðŸ«³ Group 1 ðŸŽ Flip 90 degrees to face 2
      default: []
      selector:
        action: {}
    action_flipped180_face_2:
      name: ðŸ«³ ACTION MODE ONLY ðŸ«³ Group 1 ðŸŽ Flip 180 degrees to face 2
      description: "**NOTE:** This action is trick to master, and should be used sparingly..."
      default: []
      selector:
        action: {}
    action_flip_from_any_to_face_2:
      name: ðŸ«³ ACTION MODE ONLY ðŸ«³ Group 1 ðŸŽ Flip From any face to face 2
      default: []
      selector:
        action: {}
    action_rotate_cw_face_2:
      name: ðŸ«³ ACTION MODE ONLY ðŸ«³ Group 1 ðŸŽ Rotate CW with face 2 up
      default: []
      selector:
        action: {}
    action_rotate_ccw_face_2:
      name: ðŸ«³ ACTION MODE ONLY ðŸ«³ Group 1 ðŸŽ Rotate CCW with face 2 up
      default: []
      selector:
        action: {}
    action_slide_face_3:
      name: ðŸ«³ ACTION MODE ONLY ðŸ«³ Group 1 ðŸŽ Slide with face 3 up
      default: []
      selector:
        action: {}
    action_doubletap_face_3:
      name: ðŸ«³ ACTION MODE ONLY ðŸ«³ Group 1 ðŸŽ Double tap with face 3 up
      default: []
      selector:
        action: {}
    action_flipped90_face_3:
      name: ðŸ«³ ACTION MODE ONLY ðŸ«³ Group 1 ðŸŽ Flip 90 degrees to face 3
      default: []
      selector:
        action: {}
    action_flipped180_face_3:
      name: ðŸ«³ ACTION MODE ONLY ðŸ«³ Group 1 ðŸŽ Flip 180 degrees to face 3
      description: "**NOTE:** This action is trick to master, and should be used sparingly..."
      default: []
      selector:
        action: {}
    action_flip_from_any_to_face_3:
      name: ðŸ«³ ACTION MODE ONLY ðŸ«³ Group 1 ðŸŽ Flip From any face to face 3
      default: []
      selector:
        action: {}
    action_rotate_cw_face_3:
      name: ðŸ«³ ACTION MODE ONLY ðŸ«³ Group 1 ðŸŽ Rotate CW with face 3 up
      default: []
      selector:
        action: {}
    action_rotate_ccw_face_3:
      name: ðŸ«³ ACTION MODE ONLY ðŸ«³ Group 1 ðŸŽ Rotate CCW with face 3 up
      default: []
      selector:
        action: {}
    action_slide_face_4:
      name: ðŸ«³ ACTION MODE ONLY ðŸ«³ Group 1 ðŸŽ Slide with face 4 up
      default: []
      selector:
        action: {}
    action_doubletap_face_4:
      name: ðŸ«³ ACTION MODE ONLY ðŸ«³ Group 1 ðŸŽ Double tap with face 4 up
      default: []
      selector:
        action: {}
    action_flipped90_face_4:
      name: ðŸ«³ ACTION MODE ONLY ðŸ«³ Group 1 ðŸŽ Flip 90 degrees to face 4
      default: []
      selector:
        action: {}
    action_flipped180_face_4:
      name: ðŸ«³ ACTION MODE ONLY ðŸ«³ Group 1 ðŸŽ Flip 180 degrees to face 4
      description: "**NOTE:** This action is trick to master, and should be used sparingly..."
      default: []
      selector:
        action: {}
    action_flip_from_any_to_face_4:
      name: ðŸ«³ ACTION MODE ONLY ðŸ«³ Group 1 ðŸŽ Flip From any face to face 4
      default: []
      selector:
        action: {}
    action_rotate_cw_face_4:
      name: ðŸ«³ ACTION MODE ONLY ðŸ«³ Group 1 ðŸŽ Rotate CW with face 4 up
      default: []
      selector:
        action: {}
    action_rotate_ccw_face_4:
      name: ðŸ«³ ACTION MODE ONLY ðŸ«³ Group 1 ðŸŽ Rotate CCW with face 4 up
      default: []
      selector:
        action: {}
    action_slide_face_5:
      name: ðŸ«³ ACTION MODE ONLY ðŸ«³ Group 1 ðŸŽ Slide with face 5 up
      default: []
      selector:
        action: {}
    action_doubletap_face_5:
      name: ðŸ«³ ACTION MODE ONLY ðŸ«³ Group 1 ðŸŽ Double tap with face 5 up
      default: []
      selector:
        action: {}
    action_flipped90_face_5:
      name: ðŸ«³ ACTION MODE ONLY ðŸ«³ Group 1 ðŸŽ Flip 90 degrees to face 5
      default: []
      selector:
        action: {}
    action_flipped180_face_5:
      name: ðŸ«³ ACTION MODE ONLY ðŸ«³ Group 1 ðŸŽ Flip 180 degrees to face 5
      description: "**NOTE:** This action is trick to master, and should be used sparingly..."
      default: []
      selector:
        action: {}
    action_flip_from_any_to_face_5:
      name: ðŸ«³ ACTION MODE ONLY ðŸ«³ Group 1 ðŸŽ Flip From any face to face 5
      default: []
      selector:
        action: {}
    action_rotate_cw_face_5:
      name: ðŸ«³ ACTION MODE ONLY ðŸ«³ Group 1 ðŸŽ Rotate CW with face 5 up
      default: []
      selector:
        action: {}
    action_rotate_ccw_face_5:
      name: ðŸ«³ ACTION MODE ONLY ðŸ«³ Group 1 ðŸŽ Rotate CCW with face 5 up
      default: []
      selector:
        action: {}
    action_slide_face_6:
      name: ðŸ«³ ACTION MODE ONLY ðŸ«³ Group 1 ðŸŽ Slide with face 6 up
      default: []
      selector:
        action: {}
    action_doubletap_face_6:
      name: ðŸ«³ ACTION MODE ONLY ðŸ«³ Group 1 ðŸŽ Double tap with face 6 up
      default: []
      selector:
        action: {}
    action_flipped90_face_6:
      name: ðŸ«³ ACTION MODE ONLY ðŸ«³ Group 1 ðŸŽ Flip 90 degrees to face 6
      default: []
      selector:
        action: {}
    action_flipped180_face_6:
      name: ðŸ«³ ACTION MODE ONLY ðŸ«³ Group 1 ðŸŽ Flip 180 degrees to face 6
      description: "**NOTE:** This action is trick to master, and should be used sparingly..."
      default: []
      selector:
        action: {}
    action_flip_from_any_to_face_6:
      name: ðŸ«³ ACTION MODE ONLY ðŸ«³ Group 1 ðŸŽ Flip From any face to face 6
      default: []
      selector:
        action: {}
    action_rotate_cw_face_6:
      name: ðŸ«³ ACTION MODE ONLY ðŸ«³ Group 1 ðŸŽ Rotate CW with face 6 up
      default: []
      selector:
        action: {}
    action_rotate_ccw_face_6:
      name: ðŸ«³ ACTION MODE ONLY ðŸ«³ Group 1 ðŸŽ Rotate CCW with face 6 up
      default: []
      selector:
        action: {}
    action_shake:
      name: ðŸ«³ ACTION MODE ONLY ðŸ«³ Shake the cube ðŸ©
      description: "This trigger only occurs once in the set-up.

        It can be combined in any group."
      default: []
      selector:
        action: {}
    action_throw:
      name: ðŸ«³ ACTION MODE ONLY ðŸ«³ Throw the cube ðŸ©
      description:
        " You don't actually 'Throw' the cube. The action is as follows:

        > Pick up the cube firmly.

        > Make a throwing motion with it but do not motion back towards yourself.

        > Hold it there for a second.

        > The throw trigger should be sent to Z2M.


        This trigger only occurs once in the set-up.

        It can be combined in any group."
      default: []
      selector:
        action: {}
    action_slide_any:
      name: ðŸ«³ ACTION MODE ONLY ðŸ«³ Group 2 ðŸŠ Slide on any side
      description: "Side doesn't matter on this one.

        **!!Warning!!** The automations for the specific side will also trigger. ðŸŽðŸ

        I suggest using only one of the three groups of triggers, not multiple groups..."
      default: []
      selector:
        action: {}
    action_doubletap_any:
      name: ðŸ«³ ACTION MODE ONLY ðŸ«³ Group 2 ðŸŠ Double tap on any side
      description: "Side doesn't matter on this one.

        **!!Warning!!** The automations for the specific side will also trigger. ðŸŽðŸ

        I suggest using only one of the three groups of triggers, not multiple groups..."
      default: []
      selector:
        action: {}
    action_flipped90_any:
      name: ðŸ«³ ACTION MODE ONLY ðŸ«³ Group 2 ðŸŠ Flip 90 degrees to any side
      description: "Side doesn't matter on this one.

        **!!Warning!!** The automations for the specific side will also trigger. ðŸŽðŸ

        I suggest using only one of the three groups of triggers, not multiple groups..."
      default: []
      selector:
        action: {}
    action_flipped180_any:
      name: ðŸ«³ ACTION MODE ONLY ðŸ«³ Group 2 ðŸŠ Flip 180 degrees to any side
      description:
        "NOTE: This action is trick to master, and should be used sparingly...
        Side doesn't matter on this one.

        **!!Warning!!** The automations for the specific side will also trigger. ðŸŽðŸ

        I suggest using only one of the three groups of triggers, not multiple groups..."
      default: []
      selector:
        action: {}
    action_rotate_cw_any:
      name: ðŸ«³ ACTION MODE ONLY ðŸ«³ Group 2 ðŸŠ Rotate CW on any side
      description: "Side doesn't matter on this one.

        **!!Warning!!** The automations for the specific side will also trigger. ðŸŽðŸ

        I suggest using only one of the three groups of triggers, not multiple groups..."
      default: []
      selector:
        action: {}
    action_rotate_ccw_any:
      name: ðŸ«³ ACTION MODE ONLY ðŸ«³ Group 2 ðŸŠ Rotate CCW on any side
      description: "Side doesn't matter on this one.

        **!!Warning!!** The automations for the specific side will also trigger. ðŸŽðŸ

        I suggest using only one of the three groups of triggers, not multiple groups..."
      default: []
      selector:
        action: {}
    action_1_from_6:
      name: ðŸ«³ ACTION MODE ONLY ðŸ«³ Group 3 ðŸ Flip to side 1 from side 6
      description:
        "**!!Warning!!** The flip 180 automations ðŸŽ for side 1 and the ANY
        ðŸŠ automations will also trigger.

        I suggest using only one of the three groups of triggers, not multiple groups..."
      default: []
      selector:
        action: {}
    action_1_from_2:
      name: ðŸ«³ ACTION MODE ONLY ðŸ«³ Group 3 ðŸ Flip to side 1 from side 2
      description:
        "**!!Warning!!** The flip 90 automations ðŸŽ for side 1 and the ANY
        ðŸŠ automations will also trigger.

        I suggest using only one of the three groups of triggers, not multiple groups..."
      default: []
      selector:
        action: {}
    action_1_from_3:
      name: ðŸ«³ ACTION MODE ONLY ðŸ«³ Group 3 ðŸ Flip to side 1 from side 3
      description:
        "**!!Warning!!** The flip 90 automations ðŸŽ for side 1 and the ANY
        ðŸŠ automations will also trigger.

        I suggest using only one of the three groups of triggers, not multiple groups..."
      default: []
      selector:
        action: {}
    action_1_from_4:
      name: ðŸ«³ ACTION MODE ONLY ðŸ«³ Group 3 ðŸ Flip to side 1 from side 4
      description:
        "**!!Warning!!** The flip 90 automations ðŸŽ for side 1 and the
        ANY ðŸŠ automations will also trigger.

        I suggest using only one of the three groups of triggers, not multiple groups..."
      default: []
      selector:
        action: {}
    action_1_from_5:
      name: ðŸ«³ ACTION MODE ONLY ðŸ«³ Group 3 ðŸ Flip to side 1 from side 5
      description:
        "**!!Warning!!** The flip 90 automations ðŸŽ for side 1 and the ANY
        ðŸŠ automations will also trigger.

        I suggest using only one of the three groups of triggers, not multiple groups..."
      default: []
      selector:
        action: {}
    action_2_from_1:
      name: ðŸ«³ ACTION MODE ONLY ðŸ«³ Group 3 ðŸ Flip to side 2 from side 1
      description:
        "**!!Warning!!** The flip 90 automations ðŸŽ for side 2 and the ANY
        ðŸŠ automations will also trigger.

        I suggest using only one of the three groups of triggers, not multiple groups..."
      default: []
      selector:
        action: {}
    action_2_from_3:
      name: ðŸ«³ ACTION MODE ONLY ðŸ«³ Group 3 ðŸ Flip to side 2 from side 3
      description:
        "**!!Warning!!** The flip 90 automations ðŸŽ for side 2 and the ANY
        ðŸŠ automations will also trigger.

        I suggest using only one of the three groups of triggers, not multiple groups..."
      default: []
      selector:
        action: {}
    action_2_from_4:
      name: ðŸ«³ ACTION MODE ONLY ðŸ«³ Group 3 ðŸ Flip to side 2 from side 4
      description:
        "**!!Warning!!** The flip 90 automations ðŸŽ for side 2 and the ANY
        ðŸŠ automations will also trigger.

        I suggest using only one of the three groups of triggers, not multiple groups..."
      default: []
      selector:
        action: {}
    action_2_from_5:
      name: ðŸ«³ ACTION MODE ONLY ðŸ«³ Group 3 ðŸ Flip to side 2 from side 5
      description:
        "**!!Warning!!** The flip 180 automations ðŸŽ for side 2 and the
        ANY ðŸŠ automations will also trigger.

        I suggest using only one of the three groups of triggers, not multiple groups..."
      default: []
      selector:
        action: {}
    action_2_from_6:
      name: ðŸ«³ ACTION MODE ONLY ðŸ«³ Group 3 ðŸ Flip to side 2 from side 6
      description:
        "**!!Warning!!** The flip 90 automations ðŸŽ for side 2 and the ANY
        ðŸŠ automations will also trigger.

        I suggest using only one of the three groups of triggers, not multiple groups..."
      default: []
      selector:
        action: {}
    action_3_from_1:
      name: ðŸ«³ ACTION MODE ONLY ðŸ«³ Group 3 ðŸ Flip to side 3 from side 1
      description:
        "**!!Warning!!** The flip 90 automations ðŸŽ for side 3 and the ANY
        ðŸŠ automations will also trigger.

        I suggest using only one of the three groups of triggers, not multiple groups..."
      default: []
      selector:
        action: {}
    action_3_from_2:
      name: ðŸ«³ ACTION MODE ONLY ðŸ«³ Group 3 ðŸ Flip to side 3 from side 2
      description:
        "**!!Warning!!** The flip 90 automations ðŸŽ for side 3 and the ANY
        ðŸŠ automations will also trigger.

        I suggest using only one of the three groups of triggers, not multiple groups..."
      default: []
      selector:
        action: {}
    action_3_from_4:
      name: ðŸ«³ ACTION MODE ONLY ðŸ«³ Group 3 ðŸ Flip to side 3 from side 4
      description:
        "**!!Warning!!** The flip 180 automations ðŸŽ for side 3 and the ANY
        ðŸŠ automations will also trigger.

        I suggest using only one of the three groups of triggers, not multiple groups..."
      default: []
      selector:
        action: {}
    action_3_from_5:
      name: ðŸ«³ ACTION MODE ONLY ðŸ«³ Group 3 ðŸ Flip to side 3 from side 5
      description:
        "**!!Warning!!** The flip 90 automations ðŸŽ for side 3 and the ANY
        ðŸŠ automations will also trigger.

        I suggest using only one of the three groups of triggers, not multiple groups..."
      default: []
      selector:
        action: {}
    action_3_from_6:
      name: GðŸ«³ ACTION MODE ONLY ðŸ«³ roup 3 ðŸ Flip to side 3 from side 6
      description:
        "**!!Warning!!** The flip 90 automations ðŸŽ for side 3 and the
        ANY ðŸŠ automations will also trigger.

        I suggest using only one of the three groups of triggers, not multiple groups..."
      default: []
      selector:
        action: {}
    action_4_from_1:
      name: ðŸ«³ ACTION MODE ONLY ðŸ«³ Group 3 ðŸ Flip to side 4 from side 1
      description:
        "**!!Warning!!** The flip 90 automations ðŸŽ for side 4 and the
        ANY ðŸŠ automations will also trigger.

        I suggest using only one of the three groups of triggers, not multiple groups..."
      default: []
      selector:
        action: {}
    action_4_from_2:
      name: ðŸ«³ ACTION MODE ONLY ðŸ«³ Group 3 ðŸ Flip to side 4 from side 2
      description:
        "**!!Warning!!** The flip 90 automations ðŸŽ for side 4 and the ANY
        ðŸŠ automations will also trigger.

        I suggest using only one of the three groups of triggers, not multiple groups..."
      default: []
      selector:
        action: {}
    action_4_from_3:
      name: ðŸ«³ ACTION MODE ONLY ðŸ«³ Group 3 ðŸ Flip to side 4 from side 3
      description:
        "**!!Warning!!** The flip 180 automations ðŸŽ for side 4 and the ANY
        ðŸŠ automations will also trigger.

        I suggest using only one of the three groups of triggers, not multiple groups..."
      default: []
      selector:
        action: {}
    action_4_from_5:
      name: ðŸ«³ ACTION MODE ONLY ðŸ«³ Group 3 ðŸ Flip to side 4 from side 5
      description:
        "**!!Warning!!** The flip 90 automations ðŸŽ for side 4 and the ANY
        ðŸŠ automations will also trigger.

        I suggest using only one of the three groups of triggers, not multiple groups..."
      default: []
      selector:
        action: {}
    action_4_from_6:
      name: ðŸ«³ ACTION MODE ONLY ðŸ«³ Group 3 ðŸ Flip to side 4 from side 6
      description:
        "**!!Warning!!** The flip 90 automations ðŸŽ for side 4 and the ANY
        ðŸŠ automations will also trigger.

        I suggest using only one of the three groups of triggers, not multiple groups..."
      default: []
      selector:
        action: {}
    action_5_from_1:
      name: ðŸ«³ ACTION MODE ONLY ðŸ«³ Group 3 ðŸ Flip to side 5 from side 1
      description:
        "**!!Warning!!** The flip 90 automations ðŸŽ for side 5 and the ANY
        ðŸŠ automations will also trigger. ðŸŽðŸ

        I suggest using only one of the three groups of triggers, not multiple groups..."
      default: []
      selector:
        action: {}
    action_5_from_2:
      name: ðŸ«³ ACTION MODE ONLY ðŸ«³ Group 3 ðŸ Flip to side 5 from side 2
      description:
        "**!!Warning!!** The flip 180 automations ðŸŽ for side 5 and the
        ANY ðŸŠ automations will also trigger.

        I suggest using only one of the three groups of triggers, not multiple groups..."
      default: []
      selector:
        action: {}
    action_5_from_3:
      name: ðŸ«³ ACTION MODE ONLY ðŸ«³ Group 3 ðŸ Flip to side 5 from side 3
      description:
        "**!!Warning!!** The flip 90 automations ðŸŽ for side 5 and the ANY
        ðŸŠ automations will also trigger.

        I suggest using only one of the three groups of triggers, not multiple groups..."
      default: []
      selector:
        action: {}
    action_5_from_4:
      name: ðŸ«³ ACTION MODE ONLY ðŸ«³ Group 3 ðŸ Flip to side 5 from side 4
      description:
        "**!!Warning!!** The flip 90 automations ðŸŽ for side 5 and the ANY
        ðŸŠ automations will also trigger.

        I suggest using only one of the three groups of triggers, not multiple groups..."
      default: []
      selector:
        action: {}
    action_5_from_6:
      name: ðŸ«³ ACTION MODE ONLY ðŸ«³ Group 3 ðŸ Flip to side 5 from side 6
      description:
        "**!!Warning!!** The flip 90 automations ðŸŽ for side 5 and the ANY
        ðŸŠ automations will also trigger.

        I suggest using only one of the three groups of triggers, not multiple groups..."
      default: []
      selector:
        action: {}
    action_6_from_1:
      name: ðŸ«³ ACTION MODE ONLY ðŸ«³ Group 3 ðŸ Flip to side 6 from side 1
      description:
        "**!!Warning!!** The flip 180 automations ðŸŽ for side 6 and the ANY
        ðŸŠ automations will also trigger.

        I suggest using only one of the three groups of triggers, not multiple groups..."
      default: []
      selector:
        action: {}
    action_6_from_2:
      name: ðŸ«³ ACTION MODE ONLY ðŸ«³ Group 3 ðŸ Flip to side 6 from side 2
      description:
        "**!!Warning!!** The flip 90 automations ðŸŽ for side 6 and the ANY
        ðŸŠ automations will also trigger.

        I suggest using only one of the three groups of triggers, not multiple groups..."
      default: []
      selector:
        action: {}
    action_6_from_3:
      name: ðŸ«³ ACTION MODE ONLY ðŸ«³ Group 3 ðŸ Flip to side 6 from side 3
      description:
        "**!!Warning!!** The flip 90 automations ðŸŽ for side 6 and the
        ANY ðŸŠ automations will also trigger.

        I suggest using only one of the three groups of triggers, not multiple groups..."
      default: []
      selector:
        action: {}
    action_6_from_4:
      name: ðŸ«³ ACTION MODE ONLY ðŸ«³ Group 3 ðŸ Flip to side 6 from side 4
      description:
        "**!!Warning!!** The flip 90 automations ðŸŽ for side 6 and the ANY
        ðŸŠ automations will also trigger.

        I suggest using only one of the three groups of triggers, not multiple groups..."
      default: []
      selector:
        action: {}
    action_6_from_5:
      name: ðŸ«³ ACTION MODE ONLY ðŸ«³ Group 3 ðŸ Flip to side 6 from side 5
      description:
        "**!!Warning!!** The flip 90 automations ðŸŽ for side 6 and the ANY
        ðŸŠ automations will also trigger.

        I suggest using only one of the three groups of triggers, not multiple groups..."
      default: []
      selector:
        action: {}

    scene_flip_to_face_1:
      name: ðŸ‘€ SCENE MODE ONLY ðŸ‘€ Group 1 ðŸŽ Flip to face 1 from any other face
      description: Face 1 is the one with the ''Aqara'' LOGO'
      default: []
      selector:
        action: {}
    scene_rotate_cw_face_1:
      name: ðŸ‘€ SCENE MODE ONLY ðŸ‘€ Group 1 ðŸŽ Rotate cube CW with face 1 up
      description: Face 1 is the one with the 'Aqara' LOGO
      default: []
      selector:
        action: {}
    scene_rotate_ccw_face_1:
      name: ðŸ‘€ SCENE MODE ONLY ðŸ‘€ Group 1 ðŸŽ Rotate cube CCW with face 1 up
      description: Face 1 is the one with the 'Aqara' LOGO
      default: []
      selector:
        action: {}
    scene_flip_to_face_2:
      name: ðŸ‘€ SCENE MODE ONLY ðŸ‘€ Group 1 ðŸŽ Flip to face 2 from any other face
      default: []
      selector:
        action: {}
    scene_rotate_cw_face_2:
      name: ðŸ‘€ SCENE MODE ONLY ðŸ‘€ Group 1 ðŸŽ Rotate cube CW with face 2 up
      default: []
      selector:
        action: {}
    scene_rotate_ccw_face_2:
      name: ðŸ‘€ SCENE MODE ONLY ðŸ‘€ Group 1 ðŸŽ Rotate cube CCW with face 2 up
      default: []
      selector:
        action: {}
    scene_flip_to_face_3:
      name: ðŸ‘€ SCENE MODE ONLY ðŸ‘€ Group 1 ðŸŽ Flip to face 3 from any other face
      default: []
      selector:
        action: {}
    scene_rotate_cw_face_3:
      name: ðŸ‘€ SCENE MODE ONLY ðŸ‘€ Group 1 ðŸŽ Rotate cube CW with face 3 up
      default: []
      selector:
        action: {}
    scene_rotate_ccw_face_3:
      name: ðŸ‘€ SCENE MODE ONLY ðŸ‘€ Group 1 ðŸŽ Rotate cube CCW with face 3 up
      default: []
      selector:
        action: {}
    scene_flip_to_face_4:
      name: ðŸ‘€ SCENE MODE ONLY ðŸ‘€ Group 1 ðŸŽ Flip to face 4 from any other face
      default: []
      selector:
        action: {}
    scene_rotate_cw_face_4:
      name: ðŸ‘€ SCENE MODE ONLY ðŸ‘€ Group 1 ðŸŽ Rotate cube CW with face 4 up
      default: []
      selector:
        action: {}
    scene_rotate_ccw_face_4:
      name: ðŸ‘€ SCENE MODE ONLY ðŸ‘€ Group 1 ðŸŽ Rotate cube CCW with face 4 up
      default: []
      selector:
        action: {}
    scene_flip_to_face_5:
      name: ðŸ‘€ SCENE MODE ONLY ðŸ‘€ Group 1 ðŸŽ Flip to face 5 from any other face
      default: []
      selector:
        action: {}
    scene_rotate_cw_face_5:
      name: ðŸ‘€ SCENE MODE ONLY ðŸ‘€ Group 1 ðŸŽ Rotate cube CW with face 5 up
      default: []
      selector:
        action: {}
    scene_rotate_ccw_face_5:
      name: ðŸ‘€ SCENE MODE ONLY ðŸ‘€ Group 1 ðŸŽ Rotate cube CCW with face 5 up
      default: []
      selector:
        action: {}
    scene_flip_to_face_6:
      name: ðŸ‘€ SCENE MODE ONLY ðŸ‘€ Group 1 ðŸŽ Flip to face 6 from any other face
      default: []
      selector:
        action: {}
    scene_rotate_cw_face_6:
      name: ðŸ‘€ SCENE MODE ONLY ðŸ‘€ Group 1 ðŸŽ Rotate cube CW with face 6 up
      default: []
      selector:
        action: {}
    scene_rotate_ccw_face_6:
      name: ðŸ‘€ SCENE MODE ONLY ðŸ‘€ Group 1 ðŸŽ Rotate cube CCW with face 6 up
      default: []
      selector:
        action: {}
    scene_hold:
      name: ðŸ‘€ SCENE MODE ONLY ðŸ‘€ Lift up the cube and hold it ðŸ©
      description: "This trigger only occurs once in the set-up.

        It can be combined in any group."
      default: []
      selector:
        action: {}
    scene_shake:
      name: ðŸ‘€ SCENE MODE ONLY ðŸ‘€ Shake the cube ðŸ©
      description: "This trigger only occurs once in the set-up.

        It can be combined in any group."
      default: []
      selector:
        action: {}
    scene_throw:
      name: ðŸ‘€ SCENE MODE ONLY ðŸ‘€ Throw the cube ðŸ©
      description:
        " You don't actually 'Throw' the cube. The action is as follows:

        > Pick up the cube firmly.

        > Make a throwing motion with it but do not motion back towards yourself.

        > Hold it there for a second.

        > The throw trigger should be sent to Z2M.


        This trigger only occurs once in the set-up.

        It can be combined in any group."
      default: []
      selector:
        action: {}
    scene_flip_to_side_any:
      name: ðŸ‘€ SCENE MODE ONLY ðŸ‘€ Group 2 ðŸŠ Flip to any side
      description: "Side doesn't matter on this one.

        **!!Warning!!** The automations for the specific side will also trigger. ðŸŽðŸ

        I suggest using only one of the three groups of triggers, not multiple groups..."
      default: []
      selector:
        action: {}
    scene_rotate_cw_any:
      name: ðŸ‘€ SCENE MODE ONLY ðŸ‘€ Group 2 ðŸŠ Rotate cube CW with any side
      description: "Side doesn't matter on this one.

        **!!Warning!!** The automations for the specific side will also trigger. ðŸŽðŸ

        I suggest using only one of the three groups of triggers, not multiple groups..."
      default: []
      selector:
        action: {}
    scene_rotate_ccw_any:
      name: ðŸ‘€ SCENE MODE ONLY ðŸ‘€ Group 2 ðŸŠ Rotate cube CCW with any side
      description: "Side doesn't matter on this one.

        **!!Warning!!** The automations for the specific side will also trigger. ðŸŽðŸ

        I suggest using only one of the three groups of triggers, not multiple groups..."
      default: []
      selector:
        action: {}
    scene_1_from_6:
      name: ðŸ‘€ SCENE MODE ONLY ðŸ‘€ Group 3 ðŸ Flip to side 1 from side 6
      description:
        "**!!Warning!!** The flip 180 automations ðŸŽ for side 1 and the ANY
        ðŸŠ automations will also trigger.

        I suggest using only one of the three groups of triggers, not multiple groups..."
      default: []
      selector:
        action: {}
    scene_1_from_2:
      name: ðŸ‘€ SCENE MODE ONLY ðŸ‘€ Group 3 ðŸ Flip to side 1 from side 2
      description:
        "**!!Warning!!** The flip 90 automations ðŸŽ for side 1 and the ANY
        ðŸŠ automations will also trigger.

        I suggest using only one of the three groups of triggers, not multiple groups..."
      default: []
      selector:
        action: {}
    scene_1_from_3:
      name: ðŸ‘€ SCENE MODE ONLY ðŸ‘€ Group 3 ðŸ Flip to side 1 from side 3
      description:
        "**!!Warning!!** The flip 90 automations ðŸŽ for side 1 and the ANY
        ðŸŠ automations will also trigger.

        I suggest using only one of the three groups of triggers, not multiple groups..."
      default: []
      selector:
        action: {}
    scene_1_from_4:
      name: ðŸ‘€ SCENE MODE ONLY ðŸ‘€ Group 3 ðŸ Flip to side 1 from side 4
      description:
        "**!!Warning!!** The flip 90 automations ðŸŽ for side 1 and the
        ANY ðŸŠ automations will also trigger.

        I suggest using only one of the three groups of triggers, not multiple groups..."
      default: []
      selector:
        action: {}
    scene_1_from_5:
      name: ðŸ‘€ SCENE MODE ONLY ðŸ‘€ Group 3 ðŸ Flip to side 1 from side 5
      description:
        "**!!Warning!!** The flip 90 automations ðŸŽ for side 1 and the ANY
        ðŸŠ automations will also trigger.

        I suggest using only one of the three groups of triggers, not multiple groups..."
      default: []
      selector:
        action: {}
    scene_2_from_1:
      name: ðŸ‘€ SCENE MODE ONLY ðŸ‘€ Group 3 ðŸ Flip to side 2 from side 1
      description:
        "**!!Warning!!** The flip 90 automations ðŸŽ for side 2 and the ANY
        ðŸŠ automations will also trigger.

        I suggest using only one of the three groups of triggers, not multiple groups..."
      default: []
      selector:
        action: {}
    scene_2_from_3:
      name: ðŸ‘€ SCENE MODE ONLY ðŸ‘€ Group 3 ðŸ Flip to side 2 from side 3
      description:
        "**!!Warning!!** The flip 90 automations ðŸŽ for side 2 and the ANY
        ðŸŠ automations will also trigger.

        I suggest using only one of the three groups of triggers, not multiple groups..."
      default: []
      selector:
        action: {}
    scene_2_from_4:
      name: ðŸ‘€ SCENE MODE ONLY ðŸ‘€ Group 3 ðŸ Flip to side 2 from side 4
      description:
        "**!!Warning!!** The flip 90 automations ðŸŽ for side 2 and the ANY
        ðŸŠ automations will also trigger.

        I suggest using only one of the three groups of triggers, not multiple groups..."
      default: []
      selector:
        action: {}
    scene_2_from_5:
      name: ðŸ‘€ SCENE MODE ONLY ðŸ‘€ Group 3 ðŸ Flip to side 2 from side 5
      description:
        "**!!Warning!!** The flip 180 automations ðŸŽ for side 2 and the
        ANY ðŸŠ automations will also trigger.

        I suggest using only one of the three groups of triggers, not multiple groups..."
      default: []
      selector:
        action: {}
    scene_2_from_6:
      name: ðŸ‘€ SCENE MODE ONLY ðŸ‘€ Group 3 ðŸ Flip to side 2 from side 6
      description:
        "**!!Warning!!** The flip 90 automations ðŸŽ for side 2 and the ANY
        ðŸŠ automations will also trigger.

        I suggest using only one of the three groups of triggers, not multiple groups..."
      default: []
      selector:
        action: {}
    scene_3_from_1:
      name: ðŸ‘€ SCENE MODE ONLY ðŸ‘€ Group 3 ðŸ Flip to side 3 from side 1
      description:
        "**!!Warning!!** The flip 90 automations ðŸŽ for side 3 and the ANY
        ðŸŠ automations will also trigger.

        I suggest using only one of the three groups of triggers, not multiple groups..."
      default: []
      selector:
        action: {}
    scene_3_from_2:
      name: ðŸ‘€ SCENE MODE ONLY ðŸ‘€ Group 3 ðŸ Flip to side 3 from side 2
      description:
        "**!!Warning!!** The flip 90 automations ðŸŽ for side 3 and the ANY
        ðŸŠ automations will also trigger.

        I suggest using only one of the three groups of triggers, not multiple groups..."
      default: []
      selector:
        action: {}
    scene_3_from_4:
      name: ðŸ‘€ SCENE MODE ONLY ðŸ‘€ Group 3 ðŸ Flip to side 3 from side 4
      description:
        "**!!Warning!!** The flip 180 automations ðŸŽ for side 3 and the ANY
        ðŸŠ automations will also trigger.

        I suggest using only one of the three groups of triggers, not multiple groups..."
      default: []
      selector:
        action: {}
    scene_3_from_5:
      name: ðŸ‘€ SCENE MODE ONLY ðŸ‘€ Group 3 ðŸ Flip to side 3 from side 5
      description:
        "**!!Warning!!** The flip 90 automations ðŸŽ for side 3 and the ANY
        ðŸŠ automations will also trigger.

        I suggest using only one of the three groups of triggers, not multiple groups..."
      default: []
      selector:
        action: {}
    scene_3_from_6:
      name: ðŸ‘€ SCENE MODE ONLY ðŸ‘€ Group 3 ðŸ Flip to side 3 from side 6
      description:
        "**!!Warning!!** The flip 90 automations ðŸŽ for side 3 and the
        ANY ðŸŠ automations will also trigger.

        I suggest using only one of the three groups of triggers, not multiple groups..."
      default: []
      selector:
        action: {}
    scene_4_from_1:
      name: ðŸ‘€ SCENE MODE ONLY ðŸ‘€ Group 3 ðŸ Flip to side 4 from side 1
      description:
        "**!!Warning!!** The flip 90 automations ðŸŽ for side 4 and the
        ANY ðŸŠ automations will also trigger.

        I suggest using only one of the three groups of triggers, not multiple groups..."
      default: []
      selector:
        action: {}
    scene_4_from_2:
      name: ðŸ‘€ SCENE MODE ONLY ðŸ‘€ Group 3 ðŸ Flip to side 4 from side 2
      description:
        "**!!Warning!!** The flip 90 automations ðŸŽ for side 4 and the ANY
        ðŸŠ automations will also trigger.

        I suggest using only one of the three groups of triggers, not multiple groups..."
      default: []
      selector:
        action: {}
    scene_4_from_3:
      name: ðŸ‘€ SCENE MODE ONLY ðŸ‘€ Group 3 ðŸ Flip to side 4 from side 3
      description:
        "**!!Warning!!** The flip 180 automations ðŸŽ for side 4 and the ANY
        ðŸŠ automations will also trigger.

        I suggest using only one of the three groups of triggers, not multiple groups..."
      default: []
      selector:
        action: {}
    scene_4_from_5:
      name: ðŸ‘€ SCENE MODE ONLY ðŸ‘€ Group 3 ðŸ Flip to side 4 from side 5
      description:
        "**!!Warning!!** The flip 90 automations ðŸŽ for side 4 and the ANY
        ðŸŠ automations will also trigger.

        I suggest using only one of the three groups of triggers, not multiple groups..."
      default: []
      selector:
        action: {}
    scene_4_from_6:
      name: ðŸ‘€ SCENE MODE ONLY ðŸ‘€ Group 3 ðŸ Flip to side 4 from side 6
      description:
        "**!!Warning!!** The flip 90 automations ðŸŽ for side 4 and the ANY
        ðŸŠ automations will also trigger.

        I suggest using only one of the three groups of triggers, not multiple groups..."
      default: []
      selector:
        action: {}
    scene_5_from_1:
      name: ðŸ‘€ SCENE MODE ONLY ðŸ‘€ Group 3 ðŸ Flip to side 5 from side 1
      description:
        "**!!Warning!!** The flip 90 automations ðŸŽ for side 5 and the ANY
        ðŸŠ automations will also trigger. ðŸŽðŸ

        I suggest using only one of the three groups of triggers, not multiple groups..."
      default: []
      selector:
        action: {}
    scene_5_from_2:
      name: ðŸ‘€ SCENE MODE ONLY ðŸ‘€ Group 3 ðŸ Flip to side 5 from side 2
      description:
        "**!!Warning!!** The flip 180 automations ðŸŽ for side 5 and the
        ANY ðŸŠ automations will also trigger.

        I suggest using only one of the three groups of triggers, not multiple groups..."
      default: []
      selector:
        action: {}
    scene_5_from_3:
      name: ðŸ‘€ SCENE MODE ONLY ðŸ‘€ Group 3 ðŸ Flip to side 5 from side 3
      description:
        "**!!Warning!!** The flip 90 automations ðŸŽ for side 5 and the ANY
        ðŸŠ automations will also trigger.

        I suggest using only one of the three groups of triggers, not multiple groups..."
      default: []
      selector:
        action: {}
    scene_5_from_4:
      name: ðŸ‘€ SCENE MODE ONLY ðŸ‘€ Group 3 ðŸ Flip to side 5 from side 4
      description:
        "**!!Warning!!** The flip 90 automations ðŸŽ for side 5 and the ANY
        ðŸŠ automations will also trigger.

        I suggest using only one of the three groups of triggers, not multiple groups..."
      default: []
      selector:
        action: {}
    scene_5_from_6:
      name: ðŸ‘€ SCENE MODE ONLY ðŸ‘€ Group 3 ðŸ Flip to side 5 from side 6
      description:
        "**!!Warning!!** The flip 90 automations ðŸŽ for side 5 and the ANY
        ðŸŠ automations will also trigger.

        I suggest using only one of the three groups of triggers, not multiple groups..."
      default: []
      selector:
        action: {}
    scene_6_from_1:
      name: ðŸ‘€ SCENE MODE ONLY ðŸ‘€ Group 3 ðŸ Flip to side 6 from side 1
      description:
        "**!!Warning!!** The flip 180 automations ðŸŽ for side 6 and the ANY
        ðŸŠ automations will also trigger.

        I suggest using only one of the three groups of triggers, not multiple groups..."
      default: []
      selector:
        action: {}
    scene_6_from_2:
      name: ðŸ‘€ SCENE MODE ONLY ðŸ‘€ Group 3 ðŸ Flip to side 6 from side 2
      description:
        "**!!Warning!!** The flip 90 automations ðŸŽ for side 6 and the ANY
        ðŸŠ automations will also trigger.

        I suggest using only one of the three groups of triggers, not multiple groups..."
      default: []
      selector:
        action: {}
    scene_6_from_3:
      name: ðŸ‘€ SCENE MODE ONLY ðŸ‘€ Group 3 ðŸ Flip to side 6 from side 3
      description:
        "**!!Warning!!** The flip 90 automations ðŸŽ for side 6 and the
        ANY ðŸŠ automations will also trigger.

        I suggest using only one of the three groups of triggers, not multiple groups..."
      default: []
      selector:
        action: {}
    scene_6_from_4:
      name: ðŸ‘€ SCENE MODE ONLY ðŸ‘€ Group 3 ðŸ Flip to side 6 from side 4
      description:
        "**!!Warning!!** The flip 90 automations ðŸŽ for side 6 and the ANY
        ðŸŠ automations will also trigger.

        I suggest using only one of the three groups of triggers, not multiple groups..."
      default: []
      selector:
        action: {}
    scene_6_from_5:
      name: ðŸ‘€ SCENE MODE ONLY ðŸ‘€ Group 3 ðŸ Flip to side 6 from side 5
      description:
        "**!!Warning!!** The flip 90 automations ðŸŽ for side 6 and the ANY
        ðŸŠ automations will also trigger.

        I suggest using only one of the three groups of triggers, not multiple groups..."
      default: []
      selector:
        action: {}

trigger:
  - platform: mqtt
    topic: !input topic

variables:
# Get the action command.
  action: >
    {% if trigger.payload_json.action is defined %}
      {{ trigger.payload_json.action }}
    {% else %}
      none
    {% endif %}
# Get the angle.
  angle: >
    {% if trigger.payload_json.action_angle is number %}
      {{ trigger.payload_json.action_angle | float(0.0) }}
    {% else %}
      0.0
    {% endif %}
# Get the side.
  side: >
    {% if trigger.payload_json.side is number %}
      {{ trigger.payload_json.side | int(0) }}
    {% else %}
      0
    {% endif %}
# Get the operation_mode.
  op_mode: >
    {% if trigger.payload_json.operation_mode is defined %}
      {{ trigger.payload_json.operation_mode }}
    {% else %}
      none
    {% endif %}

# Get the topic as a variable.
  topic_var: !input topic
# Generate the Friendly_name from the Topic.
  friendly_name: '{{ topic_var.split(''/'')[1] | regex_replace("[^A-Za-z0-9_/./-]", "") }}'
# Generate the device_id from the Friendly_name.
  device_id: "{{ device_id( friendly_name ) }}"
# Pull out the ieee identifier.
  ieee_id_long: "{{(( device_attr( device_id, 'identifiers') |list)[0][1]) }}"
# Generate just the number for the ieee.
  ieee_id: "{{ieee_id_long.split('_')[1] }}"

# Set the name of the Number entity.
  num_name: "last side"
# Set the entity_id of the Number entity.
  num_ha_name: "{{ 'number.' + friendly_name + '_last_side' }}"
# Get the value of this entity from HA
  num_ha_val: "{{ states(num_ha_name) | default(0) | int(0) }}"

# Get the last_side for use in logic below.
  last_side: >
    {# The first time it will not be there, so make sure its 0 instead of undefined. #}
    {% if not num_ha_val in ["undefined", "unknown", "unavailable", "none", "null", ""] %}
      {{ num_ha_val }}
    {% else %}
      0
    {% endif %}

# Set-up for Device parameters once
  mdl: "Number Helper for Z2M Cube T1-Pro Integration"
  mf: "SirGoodenough"
  sa: "house"
  sw: "2023-12-09"
  hw: "https://github.com/SirGoodenough/HA_Blueprints/blob/master/Automations/Zigbee2MQTT-Aqara-Magic-Cube-T1-Pro-CTP-R01-Xiaomi-Lumi.yaml"
  cu: "https://community.home-assistant.io/t/zigbee2mqtt-aqara-magic-cube-t1-pro-ctp-r01-xiaomi-lumi-cagl02/525111"

# Set Topics once
  config_topic_2: "{{ 'homeassistant/number/' + ieee_id + '/last_side/config' }}"
  topic_2: "{{ 'homeassistant/number/' + ieee_id + '/last_side' }}"

condition:
  - condition: or
    conditions:
      - condition: template
        alias: Check for valid Action Mode triggers
        value_template: >
          {{ trigger.payload_json is defined and
            trigger.payload_json.operation_mode is defined and
            trigger.payload_json.action is defined and
            trigger.payload_json.operation_mode == "action_mode" and
            trigger.payload_json.action in ["rotate_right", "rotate_left",
            "flip90", "flip180", "slide", "tap", "shake", "throw"] }}
      - condition: template
        alias: Check for valid Scene Mode triggers
        value_template: >
          {{ trigger.payload_json is defined and
            trigger.payload_json.operation_mode is defined and
            trigger.payload_json.action is defined and
            trigger.payload_json.operation_mode == "scene_mode" and
            trigger.payload_json.action in ["rotate_right", "rotate_left",
            "flip_to_side", "shake", "throw", "hold"] }}
  - alias: User pick
    condition: !input additional_conditions

action:
  - alias: Make number helper to store last side
    service: mqtt.publish
    data:
      "topic": "{{ config_topic_2 }}"
      "retain": true
      "payload": >
        { "name": "{{ num_name }}",
          "avty_t": "homeassistant/status",
          "uniq_id": "{{ friendly_name + '-' + device_id }}",
          "cmd_t": "{{ topic_2 }}",
          "sta_t": "{{ topic_2 }}",
          "min": "0",
          "max": "6",
          "step": "1",
          "mode": "box",
          "ret": true,
          "dev": {
            "name": "{{ friendly_name }}",
            "mdl": "{{ mdl }}",
            "mf": "{{ mf }}",
            "sa": "{{ sa }}",
            "sw": "{{ sw }}",
            "hw": "{{ hw }}",
            "cu": "{{ cu }}",
            "ids": [
              "{{ ieee_id + '-' + num_name }}"
            ]
          }
        }

  - alias: "Fire Last Action event. This is for optional troubleshooting data."
    event: cube_last_action
    event_data:
      action: "{{ action }}"
      side: "{{ side }}"
      last_side: "{{ last_side }}"
      friendly_name: "{{ friendly_name }}"
      device_id: "{{ device_id }}"
      ieee_id: "{{ ieee_id }}"
      angle: "{{ angle }}"
      mode: "{{ op_mode }}"

  - alias: "Store the current_side as the last_side for the next trigger"
    service: number.set_value
    target:
      entity_id: "{{ num_ha_name }}"
    data:
      value: "{{ side }}"

  - alias: "Choose Action Mode or Scene Mode"
    choose:
      - conditions: '{{ op_mode == "action_mode" }}'
        sequence:
          - alias: ðŸ«³ ACTION MODE ðŸ«³ Group 2 ðŸŠ and No Group ðŸ© These are action events for ANY Side
            choose:
              - conditions: '{{ action == "slide" }}'
                sequence: !input "action_slide_any"
              - conditions: '{{ action == "tap" }}'
                sequence: !input "action_doubletap_any"
              - conditions: '{{ action == "rotate_right" }}'
                sequence: !input "action_rotate_cw_any"
              - conditions: '{{ action == "rotate_left" }}'
                sequence: !input "action_rotate_ccw_any"
              - conditions: '{{ action == "shake" }}'
                sequence: !input "action_shake"
              - conditions: '{{ action == "throw" }}'
                sequence: !input "action_throw"
              - conditions: '{{ action == "flip90" }}'
                sequence:
                  - parallel:
                      - !input "action_flipped90_any"
                      - alias: These are flip to specific side from any side events
                        choose: &flip1
                          - conditions: "{{ side == 1 }}"
                            sequence: !input "action_flip_from_any_to_face_1"
                          - conditions: "{{ side == 2 }}"
                            sequence: !input "action_flip_from_any_to_face_2"
                          - conditions: "{{ side == 3 }}"
                            sequence: !input "action_flip_from_any_to_face_3"
                          - conditions: "{{ side == 4 }}"
                            sequence: !input "action_flip_from_any_to_face_4"
                          - conditions: "{{ side == 5 }}"
                            sequence: !input "action_flip_from_any_to_face_5"
                          - conditions: "{{ side == 6 }}"
                            sequence: !input "action_flip_from_any_to_face_6"
              - conditions: '{{ action == "flip180" }}'
                sequence:
                  - parallel:
                      - !input "action_flipped180_any"
                      - alias: These are flip to specific side from any side events
                        choose:
                          *flip1
          - alias: ðŸ«³ ACTION MODE ðŸ«³ Group 1 ðŸŽ These are action events based on the action broken down by side
            choose:
              - conditions: '{{ action == "slide" }}'
                sequence:
                  - alias: ðŸ«³ ACTION MODE ðŸ«³  Group 1 ðŸŽ These are slide events
                    choose:
                      - conditions: "{{ side == 1 }}"
                        sequence: !input "action_slide_face_1"
                      - conditions: "{{ side == 2 }}"
                        sequence: !input "action_slide_face_2"
                      - conditions: "{{ side == 3 }}"
                        sequence: !input "action_slide_face_3"
                      - conditions: "{{ side == 4 }}"
                        sequence: !input "action_slide_face_4"
                      - conditions: "{{ side == 5 }}"
                        sequence: !input "action_slide_face_5"
                      - conditions: "{{ side == 6 }}"
                        sequence: !input "action_slide_face_6"
              - conditions: '{{ action == "tap" }}'
                sequence:
                  - alias: ðŸ«³ ACTION MODE ðŸ«³  Group 1 ðŸŽ These are doubletap events
                    choose:
                      - conditions: "{{ side == 1 }}"
                        sequence: !input "action_doubletap_face_1"
                      - conditions: "{{ side == 2 }}"
                        sequence: !input "action_doubletap_face_2"
                      - conditions: "{{ side == 3 }}"
                        sequence: !input "action_doubletap_face_3"
                      - conditions: "{{ side == 4 }}"
                        sequence: !input "action_doubletap_face_4"
                      - conditions: "{{ side == 5 }}"
                        sequence: !input "action_doubletap_face_5"
                      - conditions: "{{ side == 6 }}"
                        sequence: !input "action_doubletap_face_6"
              - conditions: '{{ action == "flip90" }}'
                sequence:
                  - alias: ðŸ«³ ACTION MODE ðŸ«³  Group 1 ðŸŽ These are flipped90 events
                    choose:
                      - conditions: "{{ side == 1 }}"
                        sequence: !input "action_flipped90_face_1"
                      - conditions: "{{ side == 2 }}"
                        sequence: !input "action_flipped90_face_2"
                      - conditions: "{{ side == 3 }}"
                        sequence: !input "action_flipped90_face_3"
                      - conditions: "{{ side == 4 }}"
                        sequence: !input "action_flipped90_face_4"
                      - conditions: "{{ side == 5 }}"
                        sequence: !input "action_flipped90_face_5"
                      - conditions: "{{ side == 6 }}"
                        sequence: !input "action_flipped90_face_6"
              - conditions: '{{ action == "flip180" }}'
                sequence:
                  - alias: ðŸ«³ ACTION MODE ðŸ«³  Group 1 ðŸŽ These are flipped180 events
                    choose:
                      - conditions: "{{ side == 1 }}"
                        sequence: !input "action_flipped180_face_1"
                      - conditions: "{{ side == 2 }}"
                        sequence: !input "action_flipped180_face_2"
                      - conditions: "{{ side == 3 }}"
                        sequence: !input "action_flipped180_face_3"
                      - conditions: "{{ side == 4 }}"
                        sequence: !input "action_flipped180_face_4"
                      - conditions: "{{ side == 5 }}"
                        sequence: !input "action_flipped180_face_5"
                      - conditions: "{{ side == 6 }}"
                        sequence: !input "action_flipped180_face_6"
              - conditions: '{{ action == "rotate_right" }}'
                sequence:
                  - alias: ðŸ«³ ACTION MODE ðŸ«³  Group 1 ðŸŽ These are rotate CW events
                    choose:
                      - conditions: "{{ side == 1 }}"
                        sequence: !input "action_rotate_cw_face_1"
                      - conditions: "{{ side == 2 }}"
                        sequence: !input "action_rotate_cw_face_2"
                      - conditions: "{{ side == 3 }}"
                        sequence: !input "action_rotate_cw_face_3"
                      - conditions: "{{ side == 4 }}"
                        sequence: !input "action_rotate_cw_face_4"
                      - conditions: "{{ side == 5 }}"
                        sequence: !input "action_rotate_cw_face_5"
                      - conditions: "{{ side == 6 }}"
                        sequence: !input "action_rotate_cw_face_6"
              - conditions: '{{ action == "rotate_left" }}'
                sequence:
                  - alias: ðŸ«³ ACTION MODE ðŸ«³  Group 1 ðŸŽ These are rotate CCW events
                    choose:
                      - conditions: "{{ side == 1 }}"
                        sequence: !input "action_rotate_ccw_face_1"
                      - conditions: "{{ side == 2 }}"
                        sequence: !input "action_rotate_ccw_face_2"
                      - conditions: "{{ side == 3 }}"
                        sequence: !input "action_rotate_ccw_face_3"
                      - conditions: "{{ side == 4 }}"
                        sequence: !input "action_rotate_ccw_face_4"
                      - conditions: "{{ side == 5 }}"
                        sequence: !input "action_rotate_ccw_face_5"
                      - conditions: "{{ side == 6 }}"
                        sequence: !input "action_rotate_ccw_face_6"
          - alias: ðŸ«³ ACTION MODE ðŸ«³ Group 3 ðŸ Side to side jump events
            choose:
              - conditions: "{{ side == 1 }}"
                sequence:
                  - alias: ðŸ«³ ACTION MODE ðŸ«³ Group 3 ðŸ To side 1 from any events
                    choose:
                      - conditions: "{{ last_side == 2 }}"
                        sequence: !input "action_1_from_2"
                      - conditions: "{{ last_side == 3 }}"
                        sequence: !input "action_1_from_3"
                      - conditions: "{{ last_side == 4 }}"
                        sequence: !input "action_1_from_4"
                      - conditions: "{{ last_side == 5 }}"
                        sequence: !input "action_1_from_5"
                      - conditions: "{{ last_side == 6 }}"
                        sequence: !input "action_1_from_6"
              - conditions: "{{ side == 2 }}"
                sequence:
                  - alias: ðŸ«³ ACTION MODE ðŸ«³ Group 3 ðŸ To side 2 from any events
                    choose:
                      - conditions: "{{ last_side == 1 }}"
                        sequence: !input "action_2_from_1"
                      - conditions: "{{ last_side == 3 }}"
                        sequence: !input "action_2_from_3"
                      - conditions: "{{ last_side == 4 }}"
                        sequence: !input "action_2_from_4"
                      - conditions: "{{ last_side == 5 }}"
                        sequence: !input "action_2_from_5"
                      - conditions: "{{ last_side == 6 }}"
                        sequence: !input "action_2_from_6"
              - conditions: "{{ side == 3 }}"
                sequence:
                  - alias: ðŸ«³ ACTION MODE ðŸ«³ Group 3 ðŸ To side 3 from any events
                    choose:
                      - conditions: "{{ last_side == 1 }}"
                        sequence: !input "action_3_from_1"
                      - conditions: "{{ last_side == 2 }}"
                        sequence: !input "action_3_from_2"
                      - conditions: "{{ last_side == 4 }}"
                        sequence: !input "action_3_from_4"
                      - conditions: "{{ last_side == 5 }}"
                        sequence: !input "action_3_from_5"
                      - conditions: "{{ last_side == 6 }}"
                        sequence: !input "action_3_from_6"
              - conditions: "{{ side == 4 }}"
                sequence:
                  - alias: ðŸ«³ ACTION MODE ðŸ«³ Group 3 ðŸ To side 4 from any events
                    choose:
                      - conditions: "{{ last_side == 1 }}"
                        sequence: !input "action_4_from_1"
                      - conditions: "{{ last_side == 2 }}"
                        sequence: !input "action_4_from_2"
                      - conditions: "{{ last_side == 3 }}"
                        sequence: !input "action_4_from_3"
                      - conditions: "{{ last_side == 5 }}"
                        sequence: !input "action_4_from_5"
                      - conditions: "{{ last_side == 6 }}"
                        sequence: !input "action_4_from_6"
              - conditions: "{{ side == 5 }}"
                sequence:
                  - alias: ðŸ«³ ACTION MODE ðŸ«³ Group 3 ðŸ To side 5 from any events
                    choose:
                      - conditions: "{{ last_side == 1 }}"
                        sequence: !input "action_5_from_1"
                      - conditions: "{{ last_side == 2 }}"
                        sequence: !input "action_5_from_2"
                      - conditions: "{{ last_side == 3 }}"
                        sequence: !input "action_5_from_3"
                      - conditions: "{{ last_side == 4 }}"
                        sequence: !input "action_5_from_4"
                      - conditions: "{{ last_side == 6 }}"
                        sequence: !input "action_5_from_6"
              - conditions: "{{ side == 6 }}"
                sequence:
                  - alias: ðŸ«³ ACTION MODE ðŸ«³ Group 3 ðŸ To side 6 from any events
                    choose:
                      - conditions: "{{ last_side == 1 }}"
                        sequence: !input "action_6_from_1"
                      - conditions: "{{ last_side == 2 }}"
                        sequence: !input "action_6_from_2"
                      - conditions: "{{ last_side == 3 }}"
                        sequence: !input "action_6_from_3"
                      - conditions: "{{ last_side == 4 }}"
                        sequence: !input "action_6_from_4"
                      - conditions: "{{ last_side == 5 }}"
                        sequence: !input "action_6_from_5"

      - conditions: '{{ op_mode == "scene_mode" }}'
        sequence:
          - alias: ðŸ‘€ SCENE MODE ðŸ‘€ Group 2 ðŸŠ and No Group ðŸ© These are action events for ANY Side
            choose:
              - conditions: '{{ action == "flip_to_side" }}'
                sequence: !input "scene_flip_to_side_any"
              - conditions: '{{ action == "rotate_right" }}'
                sequence: !input "scene_rotate_cw_any"
              - conditions: '{{ action == "rotate_left" }}'
                sequence: !input "scene_rotate_ccw_any"
              - conditions: '{{ action == "hold" }}'
                sequence: !input "scene_hold"
              - conditions: '{{ action == "shake" }}'
                sequence: !input "scene_shake"
              - conditions: '{{ action == "throw" }}'
                sequence: !input "scene_throw"
          - alias: ðŸ‘€ SCENE MODE ðŸ‘€ Group 1 ðŸŽ These are action events based on the action broken down by side
            choose:
              - conditions: '{{ action == "flip_to_side" }}'
                sequence:
                  - alias: ðŸ‘€ SCENE MODE ðŸ‘€ Group 1 ðŸŽ These are flip_to_side events
                    choose:
                      - conditions: "{{ side == 1 }}"
                        sequence: !input "scene_flip_to_face_1"
                      - conditions: "{{ side == 2 }}"
                        sequence: !input "scene_flip_to_face_2"
                      - conditions: "{{ side == 3 }}"
                        sequence: !input "scene_flip_to_face_3"
                      - conditions: "{{ side == 4 }}"
                        sequence: !input "scene_flip_to_face_4"
                      - conditions: "{{ side == 5 }}"
                        sequence: !input "scene_flip_to_face_5"
                      - conditions: "{{ side == 6 }}"
                        sequence: !input "scene_flip_to_face_6"
              - conditions: '{{ action == "rotate_right" }}'
                sequence:
                  - alias: ðŸ‘€ SCENE MODE ðŸ‘€ Group 1 ðŸŽ These are rotate CW events
                    choose:
                      - conditions: "{{ side == 1 }}"
                        sequence: !input "scene_rotate_cw_face_1"
                      - conditions: "{{ side == 2 }}"
                        sequence: !input "scene_rotate_cw_face_2"
                      - conditions: "{{ side == 3 }}"
                        sequence: !input "scene_rotate_cw_face_3"
                      - conditions: "{{ side == 4 }}"
                        sequence: !input "scene_rotate_cw_face_4"
                      - conditions: "{{ side == 5 }}"
                        sequence: !input "scene_rotate_cw_face_5"
                      - conditions: "{{ side == 6 }}"
                        sequence: !input "scene_rotate_cw_face_6"
              - conditions: '{{ action == "rotate_left" }}'
                sequence:
                  - alias: ðŸ‘€ SCENE MODE ðŸ‘€ Group 1 ðŸŽ These are rotate CCW events
                    choose:
                      - conditions: "{{ side == 1 }}"
                        sequence: !input "scene_rotate_ccw_face_1"
                      - conditions: "{{ side == 2 }}"
                        sequence: !input "scene_rotate_ccw_face_2"
                      - conditions: "{{ side == 3 }}"
                        sequence: !input "scene_rotate_ccw_face_3"
                      - conditions: "{{ side == 4 }}"
                        sequence: !input "scene_rotate_ccw_face_4"
                      - conditions: "{{ side == 5 }}"
                        sequence: !input "scene_rotate_ccw_face_5"
                      - conditions: "{{ side == 6 }}"
                        sequence: !input "scene_rotate_ccw_face_6"
          - alias: ðŸ‘€ SCENE MODE ðŸ‘€ Group 3 ðŸ Side to side jump events
            choose:
              - conditions: "{{ side == 1 }}"
                sequence:
                  - alias: ðŸ‘€ SCENE MODE ðŸ‘€ Group 3 ðŸ To side 1 from specific events
                    choose:
                      - conditions: "{{ last_side == 2 }}"
                        sequence: !input "scene_1_from_2"
                      - conditions: "{{ last_side == 3 }}"
                        sequence: !input "scene_1_from_3"
                      - conditions: "{{ last_side == 4 }}"
                        sequence: !input "scene_1_from_4"
                      - conditions: "{{ last_side == 5 }}"
                        sequence: !input "scene_1_from_5"
                      - conditions: "{{ last_side == 6 }}"
                        sequence: !input "scene_1_from_6"
              - conditions: "{{ side == 2 }}"
                sequence:
                  - alias: ðŸ‘€ SCENE MODE ðŸ‘€ Group 3 ðŸ To side 2 from specific events
                    choose:
                      - conditions: "{{ last_side == 1 }}"
                        sequence: !input "scene_2_from_1"
                      - conditions: "{{ last_side == 3 }}"
                        sequence: !input "scene_2_from_3"
                      - conditions: "{{ last_side == 4 }}"
                        sequence: !input "scene_2_from_4"
                      - conditions: "{{ last_side == 5 }}"
                        sequence: !input "scene_2_from_5"
                      - conditions: "{{ last_side == 6 }}"
                        sequence: !input "scene_2_from_6"
              - conditions: "{{ side == 3 }}"
                sequence:
                  - alias: ðŸ‘€ SCENE MODE ðŸ‘€ Group 3 ðŸ To side 3 from specific events
                    choose:
                      - conditions: "{{ last_side == 1 }}"
                        sequence: !input "scene_3_from_1"
                      - conditions: "{{ last_side == 2 }}"
                        sequence: !input "scene_3_from_2"
                      - conditions: "{{ last_side == 4 }}"
                        sequence: !input "scene_3_from_4"
                      - conditions: "{{ last_side == 5 }}"
                        sequence: !input "scene_3_from_5"
                      - conditions: "{{ last_side == 6 }}"
                        sequence: !input "scene_3_from_6"
              - conditions: "{{ side == 4 }}"
                sequence:
                  - alias: ðŸ‘€ SCENE MODE ðŸ‘€ Group 3 ðŸ To side 4 from specific events
                    choose:
                      - conditions: "{{ last_side == 1 }}"
                        sequence: !input "scene_4_from_1"
                      - conditions: "{{ last_side == 2 }}"
                        sequence: !input "scene_4_from_2"
                      - conditions: "{{ last_side == 3 }}"
                        sequence: !input "scene_4_from_3"
                      - conditions: "{{ last_side == 5 }}"
                        sequence: !input "scene_4_from_5"
                      - conditions: "{{ last_side == 6 }}"
                        sequence: !input "scene_4_from_6"
              - conditions: "{{ side == 5 }}"
                sequence:
                  - alias: ðŸ‘€ SCENE MODE ðŸ‘€ Group 3 ðŸ To side 5 from specific events
                    choose:
                      - conditions: "{{ last_side == 1 }}"
                        sequence: !input "scene_5_from_1"
                      - conditions: "{{ last_side == 2 }}"
                        sequence: !input "scene_5_from_2"
                      - conditions: "{{ last_side == 3 }}"
                        sequence: !input "scene_5_from_3"
                      - conditions: "{{ last_side == 4 }}"
                        sequence: !input "scene_5_from_4"
                      - conditions: "{{ last_side == 6 }}"
                        sequence: !input "scene_5_from_6"
              - conditions: "{{ side == 6 }}"
                sequence:
                  - alias: ðŸ‘€ SCENE MODE ðŸ‘€ Group 3 ðŸ To side 6 from specific events
                    choose:
                      - conditions: "{{ last_side == 1 }}"
                        sequence: !input "scene_6_from_1"
                      - conditions: "{{ last_side == 2 }}"
                        sequence: !input "scene_6_from_2"
                      - conditions: "{{ last_side == 3 }}"
                        sequence: !input "scene_6_from_3"
                      - conditions: "{{ last_side == 4 }}"
                        sequence: !input "scene_6_from_4"
                      - conditions: "{{ last_side == 5 }}"
                        sequence: !input "scene_6_from_5"

  - alias:
      Delay â± for debounce so toggle functions work. Also blueprint is in single
      mode.
    delay: 00:00:01

mode: single
max_exceeded: silent
